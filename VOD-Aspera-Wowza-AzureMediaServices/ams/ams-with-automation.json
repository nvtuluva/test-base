{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "mediaServicesName": {
            "defaultValue": "media",
            "type": "string"
        },
        "inputStorageAccountsName": {
            "defaultValue": "input",
            "type": "string"
        },
        "outputStorageAccountsName": {
            "defaultValue": "output",
            "type": "string"
        },
        "mediaServiceStorageAccountsName": {
            "defaultValue": "mediab",
            "type": "string"
        },
        "storageApiVersion": {
            "type": "string",
            "defaultValue": "2015-06-15",
            "allowedValues": [
                "2015-05-01-preview",
                "2015-06-15"
            ],
            "metadata": {
                "description": "API Version for the Storage Account"
            }
        },
        "location": {
            "type": "string",
            "defaultValue": "West US",
            "allowedValues": [
                "Brazil South",
                "East Asia",
                "East US",
                "Japan East",
                "Japan West",
                "North Central US",
                "North Europe",
                "South Central US",
                "West Europe",
                "West US",
                "Southeast Asia",
                "Central US",
                "East US 2"
            ],
            "metadata": {
                "description": "Storage Account Deployment Location"
            }
        },
        "tag": {
            "type": "object",
            "defaultValue": {
                "key1": "key",
                "value1": "value"
            },
            "metadata": {
                "description": "Tag Values"
            }
        },
        "storageAccountType": {
            "type": "string",
            "defaultValue": "Standard_LRS",
            "allowedValues": [
                "Standard_LRS",
                "Standard_ZRS",
                "Standard_GRS",
                "Standard_RAGRS",
                "Premium_LRS"
            ],
            "metadata": {
                "description": "Stoarge Account Type"
            }
        },
        "jobId": {
            "type": "string",
            "defaultValue": "24b18f62-aa2c-4528-ac10-1e3602eb4053",
            "metadata": {
                "description": "Generate a Job ID (GUID) from https://www.guidgenerator.com/online-guid-generator.aspx "
            }
        },
        "automationSku": {
            "type": "string",
            "defaultValue": "Basic",
            "allowedValues": [
                "Free",
                "Basic"
            ]
        },
        "automationLocation": {
            "type": "string",
            "defaultValue": "North Europe",
            "allowedValues": [
                "Japan East",
                "North Europe",
                "South Central US",
                "West Europe",
                "Southeast Asia",
                "East US 2"
            ]
        }
    },
    "variables": {
        "inputStorageAccountsName": "[concat(parameters('inputStorageAccountsName'),uniqueString(resourceGroup().id))]",
        "outputStorageAccountsName": "[concat(parameters('outputStorageAccountsName'),uniqueString(resourceGroup().id))]",
        "mediaServiceStorageAccountsName": "[concat(parameters('mediaServiceStorageAccountsName'),uniqueString(resourceGroup().id))]",
        "mediaServicesName": "[concat(parameters('mediaServicesName'),uniqueString(resourceGroup().id))]",
        "automationUrl": "https://raw.githubusercontent.com/ashwinse/azuremedia/master/azure-mediaservices-automation.json",
        "automationAccountName": "azureMediaSrcAutoAcc",
        "runbookUrl": " https://raw.githubusercontent.com/sysgain/azurequickstarts/master/VOD-Aspera-Wowza-AzureMediaServices/ams/MediaservicesRestapi1.ps1",
        "runbookName": "myrunbook"
    },
    "resources": [
        {
            "comments": "Storage Account Resource",
            "type": "Microsoft.Storage/storageAccounts",
            "name": "[variables('inputStorageAccountsName')]",
            "apiVersion": "[parameters('storageApiVersion')]",
            "location": "[parameters('location')]",
            "tags": {
                "[parameters('tag').key1]": "[parameters('tag').value1]"
            },
            "properties": {
                "accountType": "[parameters('storageAccountType')]"
            }
        },
        {
            "comments": "Storage Account Resource",
            "type": "Microsoft.Storage/storageAccounts",
            "name": "[variables('outputStorageAccountsName')]",
            "apiVersion": "[parameters('storageApiVersion')]",
            "location": "[parameters('location')]",
            "tags": {
                "[parameters('tag').key1]": "[parameters('tag').value1]"
            },
            "properties": {
                "accountType": "[parameters('storageAccountType')]"
            }
        },
        {
            "type": "Microsoft.Storage/storageAccounts",
            "name": "[variables('mediaServiceStorageAccountsName')]",
            "apiVersion": "[parameters('storageApiVersion')]",
            "location": "[parameters('location')]",
            "tags": {
                "[parameters('tag').key1]": "[parameters('tag').value1]"
            },
            "properties": {
                "accountType": "[parameters('storageAccountType')]"
            }
        },
        {
            "type": "Microsoft.Media/mediaServices",
            "name": "[variables('mediaServicesName')]",
            "apiVersion": "2015-10-01",
            "location": "East US",
            "properties": {
                "storageAccounts": [
                    {
                        "id": "[resourceId('Microsoft.Storage/storageAccounts', variables('mediaServiceStorageAccountsName'))]",
                        "isPrimary": true
                    }
                ]
            },
            "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', variables('mediaServiceStorageAccountsName'))]"
            ]
        },
        {
            "name": "automationJob",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2015-01-01",
            "dependsOn": [
                "[resourceId('Microsoft.Media/mediaServices', variables('mediaServicesName'))]",
                "[resourceId('Microsoft.Storage/storageAccounts', variables('outputStorageAccountsName'))]",
                "[resourceId('Microsoft.Storage/storageAccounts', variables('inputStorageAccountsName'))]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('automationUrl')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('automationLocation')]"
                    },
                    "automationAccountName": {
                        "value": "[variables('automationAccountName')]"
                    },
                    "sku": {
                        "value": "[parameters('automationSku')]"
                    },
                    "runbookUrl": {
                        "value": "[variables('runbookUrl')]"
                    },
                    "runbookName": {
                        "value": "[variables('runbookName')]"
                    },
                    "mediaServicesName": {
                        "value": "[variables('mediaServicesName')]"
                    },
                    "mediaServicesKeys": {
                        "value": "[listKeys(resourceId('Microsoft.Media/mediaservices', variables('mediaServicesName')), '2015-10-01').primaryKey]"
                    },
                    "inputStorageAccountsName": {
                        "value": "[variables('inputStorageAccountsName')]"
                    },
                    "inputStorageAccountsKeys": {
                        "value": "[listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('inputStorageAccountsName')), providers('Microsoft.Storage', 'storageAccounts').apiVersions[0]).keys[0].value]"
                    },
                    "outputStorageAccountsName": {
                        "value": "[variables('outputStorageAccountsName')]"
                    },
                    "outputStorageAccountsKeys": {
                        "value": "[listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('outputStorageAccountsName')), providers('Microsoft.Storage', 'storageAccounts').apiVersions[0]).keys[0].value]"
                    },
                    "mediaServiceStorageAccountsName": {
                        "value": "[variables('mediaServiceStorageAccountsName')]"
                    },
                    "mediaServiceStorageAccountsKeys": {
                        "value": "[listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('mediaServiceStorageAccountsName')), providers('Microsoft.Storage', 'storageAccounts').apiVersions[0]).keys[0].value]"
                    },
                    "jobId": {
                        "value": "[parameters('jobId')]"
                    }
                }
            }
        }
    ]
}
